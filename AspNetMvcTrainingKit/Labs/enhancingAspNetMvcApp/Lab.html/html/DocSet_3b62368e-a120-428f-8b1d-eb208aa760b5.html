<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 1: Verification" />
      <MSHelp:RLTitle Title="Exercise 1: Verification" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 1: Verification</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/jscript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/jscript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/jscript" language="jscript"> </script>
    <script src="../local/script.js" type="text/jscript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">Enhancing Asp.NET MVC Applications</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 1: Verification</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>In order to verify that you have correctly performed all steps of exercise one, proceed as follows:</p>
        <a name="_Toc224120015" href="#">
          <span />
        </a>
        <h3 class="subheading">Verification 1</h3>
        <p>You will execute CRUD operations with the simple application to make sure that they work in the same fashion as the starting solution, but with the newly implemented features.</p>
        <ol>
          <li>To test the MVC Web Application you need to start a new instance of the <b>MvcSampleApp</b> project. To do this, in <b>Solution Explorer</b> right-click <b>MvcSampleApp</b> project, point to <b>Debug</b> and select <b>Start New Instance</b>.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> If the dialog <b>Debugging Not Enabled</b> appears, select <b>Modify the Web.config file to enable debugging</b> and click <b>OK</b>.</td></tr></table><p /></div><br /></li>
          <li>You will be directed to<b><a href="http://localhost:50000/">http://localhost:50000/</a></b>. This is the home page of the MVC Web Application, and it is generated by the ASP.NET MVC framework by calling Home Controller’s <b>Index </b>meth<b> </b>and then rendering the Home controller’s<b> Index </b>View.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> In this case <b>Index</b> method only renders the view, since no data is needed by the Home controller’s<b> Index </b>View.</td></tr></table><p /></div><br /><p><img src="images\14702bf2-ee3a-43c2-99a4-cb12fecfc1b6.png" /></p><p><b>Figure 1</b><br /><i>MVC Sample Application home page</i></p><br /></li>
          <li>To browse customers, click <b>Customers</b> link on page header. You will be redirected to the following address in the web browser <a href="http://localhost:50000/Customers">http://localhost:50000/Customers</a>  which invokes <b>Index</b> method on the <b>CustomerController</b>. The following output should appear. Previous and Next Page links are provided to navigate through all customers. The page showed by default is page one.</li>
          <li>
            <p>
              <img src="images\f8aa47f5-31a0-4cea-9309-f7be55b4988f.png" />
            </p>
            <p>
              <b>Figure 2</b>
              <br />
              <i>Customers Index page</i>
            </p>
            <br />
          </li>
          <li>To view a specific customer’s details, click on its name. For example if you click the "Fitness Hotel - Sharon Looney" customer (on the third page of the list), you will be redirected to <a href="http://localhost:50000/Customers/Info/39">http://localhost:50000/Customers/Info/39</a>  (where "39" is the <b>CustomerId</b>).  The <b>Info</b> method of the <b>CustomerController</b> controller is invoked, which retrieves customer data, and pass it to the <b>Info </b>view when rendering it. The details on the given customer and its currently associated addresses will be shown. The output will be similar to the following.<p><img src="images\ac8941b1-717f-43da-9980-5d88537db16f.png" /></p><p><b>Figure 3</b><br /><i>Customer Info page</i></p><br /></li>
          <li>Set a breakpoint on the first line of the <b>SaveNew</b> method of the <b>AddressController</b> controller, as shown in Figure 4: <p><img src="images\7d72e8c1-0b18-497b-ac86-32a24c59f0fd.png" /></p><a name="_Ref224108056" href="#"><span /></a><p><b>Figure 4</b><br /><i>Breakpoint in SaveNew method</i></p><br /></li>
          <li>To create a new address for the selected customer, click the <b>Add New Address</b> link. You will be redirected to <a href="http://localhost:50000/Address/Create?CustomerID=??">http://localhost:50000/Address/Create?CustomerID=??</a>  (where <b>??</b> is the customer ID.<p><img src="images\0cfe655e-a742-482f-87d1-b84ff9085eee.png" /></p><p><b>Figure 5</b><br /><i>Create Address page</i></p><br /></li>
          <li>Complete the required information and click the <b>Create</b> button. The application will stop on the breakpoint set on the <b>SaveNew</b> method, verifying that the <b>ActionName</b> attribute is directing the Create action when posting to that method.<p><img src="images\9c5b6fd7-5843-4b7c-a2ac-227678bce227.png" /></p><p><b>Figure 6</b><br /><i>Application stopped at the breakpoint</i></p><br /></li>
          <li>Remove the breakpoint and press <b>F5</b> to continue with the application execution.</li>
          <li>To edit the newly created address click the <b>(Edit)</b> link, located at the right of the new address, as shown Figure 7.<p><img src="images\0fa4916e-d03c-43f4-a601-4d65d3b3d0bd.png" /></p><p><b>Figure 7</b><br /><i>Edit the newly created address</i></p><br /></li>
          <li>Change the <b>Address Line 1</b> field value to "Modified address" and click <b>Save</b>. Verify that the address has been updated.<p><img src="images\9d9d80bd-04ba-4ab0-82d3-3da0d464c4c0.png" /></p><p><b>Figure 8</b><br /><i>Address updated</i></p><br /></li>
          <li>To delete the created address click the <b>(Delete)</b> link, located next to the address. Verify that the address has been deleted.<p><img src="images\d1066a1a-b24d-47cc-af28-f2f13ab5664e.png" /></p><p><b>Figure 9</b><br /><i>Address deleted</i></p><br /></li>
        </ol>
        <a name="_Toc190145448" href="#">
          <span />
        </a>
        <a name="_Toc223351758" href="#">
          <span />
        </a>
        <a name="_Toc223432920" href="#">
          <span />
        </a>
        <a name="_Toc223948243" href="#">
          <span />
        </a>
        <a name="_Toc224120016" href="#">
          <span />
        </a>
        <h3 class="subheading">Verification 2</h3>
        <p>In this verification you will check that the <b>AddressViewDataBinder</b> binder is being used by the ASP.NET MVC framework to update the model from the Create and Edit pages' fields.</p>
        <ol>
          <li>Start a new instance of the <b>MvcSampleApp</b> project. Right-click <b>MvcSampleApp</b> project in <b>Solution Explorer,</b> point to <b>Debug</b> and select <b>Start New Instance</b>. Alternatively you can continue using the instance used in the previous verification.</li>
          <li>Open the Customer controller’s<b> Index</b> view with the list of customers. To do this, click the <b>Customers</b> link in the page header.</li>
          <li>To view a specific customer’s details, click its name. The details on the given customer and its currently associated addresses will be shown.</li>
          <li>To create an address of the selected customer, click the <b>Add New Address</b> link.</li>
          <li>Set a breakpoint on the first line of the <b>AddressViewDataBinderBindModel</b> method:<p><img src="images\3cf985d3-8c1d-41eb-9daa-66a3770c43d2.png" /></p><p><b>Figure 10</b><br /><i>Breakpoint on BindModel method</i></p><br /></li>
          <li>Complete the required information and click <b>Create</b>. Verify that application stops on the breakpoint.</li>
          <li>Check in the <b>Call Stack</b> that the <b>UpdateModel</b> method called from the <b>SaveNew</b> method of the <b>AddressController</b> controller has invoked the <b>BindModel</b> method of the <b>AddressViewDataBinder</b> class. To access the Call Stack window, click the <b>Debug</b> menu, point to <b>Windows</b> and click <b>Call Stack</b>. <p>The call stack window output should look like the following:</p><p><img src="images\d010473e-6188-48f3-a147-1d0a5a5a87f6.png" /></p><p><b>Figure 11</b><br /><i>Visual Studio 2008 Call Stack window</i></p><br /></li>
          <li>Check that the invoking method was <b>UpdateModel.</b> To do this, double-click the following line:<p><b>MvcSampleApp.DLL!MvcSampleApp.Controllers.AddressController.SaveNew</b>.</p><p><img src="images\2473da0a-1e07-466d-961f-e69ada9716dd.png" /></p><p><b>Figure 12</b><br /><i>UpdateModel on the call stack</i></p><br /></li>
          <li>Press <b>F5</b> to continue with application execution.</li>
          <li>Edit the newly created address. To do this, click the <b>(Edit)</b> link, located next to the new address.</li>
          <li>Click <b>Save</b> and verify that application stops on the breakpoint. This step does not require data modification.</li>
          <li>Check in the <b>Call Stack</b> that the <b>TryUpdateModel</b> method called from the <b>Edit</b> method of the <b>AddressController</b> controller has invoked the <b>BindModel</b> method of the <b>AddressViewDataBinder</b> class. </li>
        </ol>
        <p>The output of the Call Stack window should look like the following.</p>
        <p>
          <img src="images\a9070891-f15c-4614-a0c5-4598ca35af76.png" />
        </p>
        <p>
          <b>Figure 13</b>
          <br />
          <i>Visual Studio 2008 Call Stack window</i>
        </p>
        <br />
        <ol>
          <li>Check that the invoking method was <b>TryUpdateModel</b>. To do this, double-click the following line: <p><b>MvcSampleApp.DLL!MvcSampleApp.Controllers.AddressController.Edit</b></p><p><img src="images\4a4e4656-44a3-4f8d-995f-a70d493dd89d.png" /></p><p><b>Figure 14</b><br /><i>TryUpdateModel on the call stack</i></p><br /></li>
          <li>Press <b>F5</b> to continue with application execution.</li>
          <li>Delete the created address by clicking the <b>(Delete) </b>link, located next to the address created for this verification.</li>
        </ol>
        <a name="_Toc223948244" href="#">
          <span />
        </a>
        <a name="_Toc224120017" href="#">
          <span />
        </a>
        <h3 class="subheading">Verification 3</h3>
        <p>In this last verification you will check the behavior of the <b>TryUpdateModel</b> helper method when an error occurs in the binding.</p>
        <ol>
          <li>Open the <b>AddressViewDataBinder.cs</b> file. To do this, double click the file in the <b>Solution Explorer</b>.</li>
          <li>Add the following using statement at the top of the file:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>using System;</pre></td></tr></table></span></div><br /></li>
          <li>Introduce an error in the model using the <b>AddModelError</b> method. To do this, replace the last line of the <b>BindModel</b> method of the <b>AddressViewDataBinder</b> class with the following bolded code.<p>(Code Snippet – <i>Enhancing Asp.Net MVC Lab – BindModel</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public object BindModel(ControllerContext controllerContext, ModelBindingContext bindingContext){    AddressViewData addressViewData = (AddressViewData)bindingContext.Model;    if (addressViewData.Address == null)    {        addressViewData.Address = new Address();    }    addressViewData.CustomerId = GetValueFromProvider&lt;int&gt;(bindingContext, "CustomerId");<b>    RetrieveAddressViewDataFromContext(addressViewData, bindingContext);</b><b>    bindingContext.ModelState.AddModelError("Address.City", new System.Exception());</b><b>    bindingContext.ModelState.SetModelValue("Address.City", bindingContext.ValueProvider["Address.City"]);</b><b>    return null;</b>}</pre></td></tr></table></span></div><p>The following figure shows the updated code that provokes an error.</p><p><img src="images\604662b9-b863-4024-a53c-14143932994e.png" /></p><p><b>Figure 15</b><br /><i>Modified AddressViewDataBinder.BindModel method</i></p><br /></li>
          <li>Build the solution and start a new instance of the <b>MvcSampleApp</b> project. Right-click the <b>MvcSampleApp</b> project in <b>Solution Explorer,</b> point to <b>Debug</b> and select <b>Start New Instance</b>. </li>
          <li>Open the Customer controller’s<b> Index</b> view with the list of customers. To do this, click the <b>Customers</b> link in the page header.</li>
          <li>To view a specific customer’s details, click its name. The details on the given customer and its currently associated addresses will be shown.</li>
          <li>Edit an address by clicking the <b>(Edit)</b> link. Change the values of the form's fields and click <b>Save</b>.</li>
          <li>Verify that the <b>City</b> field is highlighted and that the error message is being shown. Notice that the changed values remain on the form after the error is shown.<p><img src="images\35a3dd64-8000-4875-9b12-98ad90d4cfe9.png" /></p><p><b>Figure 16</b><br /><i>Edit page with error</i></p><br /></li>
          <li>Stop the application.</li>
          <li>Rollback the changes made on the <b>BindModel</b> method of the <b>AddressViewDataBinder</b> class by replacing the last four lines of the method with the original line, as shown in the following code:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public object BindModel(ControllerContext controllerContext, ModelBindingContext bindingContext){    AddressViewData addressViewData = (AddressViewData)bindingContext.Model;    if (addressViewData.Address == null)    {        addressViewData.Address = new Address();    }    addressViewData.CustomerId = GetValueFromProvider&lt;int&gt;(bindingContext, "CustomerId");<b>return RetrieveAddressViewDataFromContext(addressViewData, bindingContext);</b>}</pre></td></tr></table></span></div></li>
        </ol>
        <br />
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to mvckit@microsoft.com<p />Copyright © 2009 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>